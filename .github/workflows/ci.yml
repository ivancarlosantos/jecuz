name: Deploy Prod via Workflow Dispatch

on:
  pull_request:
    branches: [ master ]

  workflow_dispatch:
    inputs:
      target_branch:
        description: "Branch para executar o workflow"
        required: true
        default: "master"
        type: choice
        options:
          - master
          - release
          - feature

      version:
        description: "Versão da aplicação para deploy"
        required: true
        default: stable
        type: choice
        options:
          - stable
          - latest
          - custom
          - release

      environment_name:
        description: "Nome do ambiente para deploy"
        required: true
        default: production
        type: string

      environment_type:
        description: "Tipo do ambiente"
        required: true
        default: production
        type: choice
        options:
          - certified
          - preproduction
          - production

jobs:
  setup-environment:
    name: Setup Environment
    runs-on: ubuntu-latest
    outputs:
      version_hash: ${{ steps.get_hash.outputs.version_hash }}
      name: setup-environment
      run: echo version hash ${{ steps.get_hash.outputs.version_hash }}

    steps:
      - name: Checkout target branch
        uses: actions/checkout@v4.2.2
        with:
          ref: ${{ github.event.inputs.target_branch }}

      - name: Setup JDK 17
        uses: actions/setup-java@v4.7.0
        with:
          distribution: 'temurin'
          java-version: 17
          cache: 'maven'

      - name: Get input version hash
        id: get_hash
        run: |
          VERSION="${{ github.event.inputs.version }}"
          HASH=$(echo -n $VERSION | sha256sum | cut -d ' ' -f1)
          echo "version_hash=$HASH" >> $GITHUB_OUTPUT

  validate-environment:
    name: Validate Environment Information
    runs-on: ubuntu-latest
    needs: setup-environment

    steps:
      - name: Validate rules
        run: |
          BRANCH="${{ github.event.inputs.target_branch }}"
          ENV_TYPE="${{ github.event.inputs.environment_type }}"

          if [[ "$ENV_TYPE" == "production" && "$BRANCH" != "master" ]]; then
            echo "Production deploy só pode ocorrer a partir da master!"
            exit 1
          fi

          if [[ "$ENV_TYPE" == "certified" && "$BRANCH" == "feature" ]]; then
            echo "Certified não pode vir de feature branch!"
            exit 1
          fi

          echo "Validação OK!"

  parallel-tests:
    name: Parallel Tests
    runs-on: ubuntu-latest
    needs: validate-environment
    if: github.event.inputs.target_branch == 'release' || github.event.inputs.target_branch == 'master'

    strategy:
      matrix:
        test_type: [unit, integration, smoke, e2e]

    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2
        with:
          ref: ${{ github.event.inputs.target_branch }}

      - name: Run ${{ matrix.test_type }} tests
        run: |
          echo "Executando testes ${{ matrix.test_type }}"
          mvn test -Dtest.type=${{ matrix.test_type }}

  prepared-deploy-prod:
    name: Prepare Prod Deploy
    runs-on: ubuntu-latest
    needs:
      - validate-environment
      - parallel-tests

    steps:
      - uses: actions/checkout@v4.2.2
      - name: Set up JDK 17
        uses: actions/setup-java@v4.7.0
        with:
          java-version: 17
          distribution: 'temurin'
          cache: 'maven'

      - name: Print Deploy Information
        run: |
          echo "Branch: ${{ github.event.inputs.target_branch }}"
          echo "Versão: ${{ github.event.inputs.version }}"
          echo "Ambiente: ${{ github.event.inputs.environment_name }}"
          echo "Tipo ambiente: ${{ github.event.inputs.environment_type }}"

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: prepared-deploy-prod

    environment:
      name: ${{ github.event.inputs.environment_name }}

    steps:
      - uses: actions/checkout@v4.2.2
      - name: Set up JDK 17
        uses: actions/setup-java@v4.7.0
        with:
          java-version: 17
          distribution: 'temurin'
          cache: 'maven'
          
      - name: Deploy Application
        run: echo "Deploying version ${{ github.event.inputs.version }} to ${{ github.event.inputs.environment_name }} environment"

      - name: Login to Docker Hub
        run: docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Docker Image
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/jecuz .
     
      - name: Send Docker Image to Registry Docker Hub
        run: docker push ${{ secrets.DOCKER_USERNAME }}/jecuz
