name: Deploy via Workflow Dispatch

on:
  pull_request:
    branches:
      - release
  workflow_dispatch:
    inputs:
      target_branch:
        description: "Branch para executar o workflow"
        required: true
        default: "master"
        type: choice
        options:
          - master
          - release
          - feature

      version:
        description: "Versão da aplicação (ex: 1.2.3)"
        required: true
        type: string

      environment_name:
        description: "Nome do ambiente para deploy"
        required: true
        type: string

      environment_type:
        description: "Tipo do ambiente"
        required: true
        type: choice
        options:
          - certified
          - preproduction
          - production

jobs:
  setup-environment:
    name: Setup Environment
    runs-on: ubuntu-latest
    outputs:
      version_hash: ${{ steps.get_hash.outputs.version_hash }}

    steps:
      - name: Checkout target branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_branch }}

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 17

      - name: Setup Maven Cache
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: maven-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}

      - name: Get input version hash
        id: get_hash
        run: |
          VERSION="${{ github.event.inputs.version }}"
          HASH=$(echo -n $VERSION | sha256sum | cut -d ' ' -f1)
          echo "version_hash=$HASH" >> $GITHUB_OUTPUT

  validate-environment:
    name: Validate Environment Information
    runs-on: ubuntu-latest
    needs: setup-environment

    steps:
      - name: Validate rules
        run: |
          BRANCH="${{ github.event.inputs.target_branch }}"
          ENV_TYPE="${{ github.event.inputs.environment_type }}"

          if [[ "$ENV_TYPE" == "production" && "$BRANCH" != "master" ]]; then
            echo "Production deploy só pode ocorrer a partir da master!"
            exit 1
          fi

          if [[ "$ENV_TYPE" == "certified" && "$BRANCH" == "feature" ]]; then
            echo "Certified não pode vir de feature branch!"
            exit 1
          fi

          echo "Validação OK!"

  parallel-tests:
    name: Parallel Tests
    runs-on: ubuntu-latest
    needs: validate-environment
    if: github.event.inputs.target_branch == 'master'

    strategy:
      matrix:
        test_type: [unit, integration, smoke, e2e]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_branch }}

      - name: Run ${{ matrix.test_type }} tests
        run: |
          echo "Executando testes ${{ matrix.test_type }}"
          mvn test -Dtest.type=${{ matrix.test_type }}

  prepared-deploy-pre:
    name: Prepare Pre Deploy
    runs-on: ubuntu-latest
    needs:
      - validate-environment
      - parallel-tests
    if: always() && (needs.parallel-tests.result == 'success' || github.event.inputs.target_branch != 'master')

    steps:
      - name: Print Deploy Information
        run: |
          echo "Branch: ${{ github.event.inputs.target_branch }}"
          echo "Versão: ${{ github.event.inputs.version }}"
          echo "Hash versão: ${{ needs.setup-environment.outputs.version_hash }}"
          echo "Ambiente: ${{ github.event.inputs.environment_name }}"
          echo "Tipo ambiente: ${{ github.event.inputs.environment_type }}"

      - name: Build Application
        run: mvn clean package -DskipTests

      - name: Login to Docker Hub
        run: docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: prepared-deploy-pre

    environment:
      name: ${{ github.event.inputs.environment_name }}

    steps:
      - name: Deploy Application
        run: echo "Deploying version ${{ github.event.inputs.version }} to ${{ github.event.inputs.environment_name }} environment"

      - name: Build Docker Image
        run: docker build -t jecuz .

      - name: Tag Docker Image
        run: docker tag ${{ secrets.DOCKER_USERNAME }}/jecuz ${{ secrets.DOCKER_USERNAME }}/jecuz:release

      - name: Send Docker Image to Registry Docker Hub
        run: docker push ${{ secrets.DOCKER_USERNAME }}/jecuz:release